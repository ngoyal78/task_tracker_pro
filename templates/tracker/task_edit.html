{% extends 'tracker/base_generic.html' %}

{% block title %}Edit Task: {{ task.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row mb-3">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="{% url 'task_detail' task.id %}">Task Details</a></li>
          <li class="breadcrumb-item active" aria-current="page">Edit Task</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h2 class="mb-0 text-primary">
        <i class="fas fa-edit me-2"></i>Edit Task: {{ task.title }}
      </h2>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="title" class="form-label">Task Title:</label>
            {% if is_owner_or_leader %}
              {{ form.title }}
            {% else %}
              <input type="text" class="form-control" value="{{ task.title }}" readonly>
            {% endif %}
          </div>
          
          <div class="col-md-6 mb-3">
            <label for="id_category" class="form-label">Category:</label>
            {% if is_owner_or_leader %}
              {{ form.category }}
            {% else %}
              <input type="text" class="form-control" value="{{ task.category.name }}" readonly>
            {% endif %}
          </div>
        </div>
        
        <div class="mb-3">
          <label for="id_description" class="form-label">Description:</label>
          {% if is_owner_or_leader %}
            {{ form.description }}
          {% else %}
            <textarea class="form-control" rows="4" readonly>{{ task.description }}</textarea>
          {% endif %}
        </div>
        
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="id_priority" class="form-label">Priority:</label>
            {% if is_owner_or_leader %}
              {{ form.priority }}
            {% else %}
              <input type="text" class="form-control" value="{{ task.priority }}" readonly>
            {% endif %}
          </div>
          
          <div class="col-md-4 mb-3">
            <label for="status" class="form-label">Status:</label>
            <select class="form-control" id="status" name="status" required>
              <option value="Not Started" {% if task.status == 'Not Started' %}selected{% endif %}>Not Started</option>
              <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
              <option value="Submitted for Approval" {% if task.status == 'Submitted for Approval' %}selected{% endif %}>Submitted for Approval</option>
              <option value="Approved" {% if task.status == 'Approved' %}selected{% endif %}>Approved</option>
              <option value="Reassigned" {% if task.status == 'Reassigned' %}selected{% endif %}>Reassigned</option>
            </select>
          </div>
          
          <div class="col-md-4 mb-3">
            <label for="id_due_date" class="form-label">Due Date:</label>
            {% if is_owner_or_leader %}
              {{ form.due_date }}
            {% else %}
              <input type="text" class="form-control" value="{{ task.due_date }}" readonly>
            {% endif %}
          </div>
        </div>
        
        <div class="mb-3">
          <label for="assigned_to" class="form-label">Assign To:</label>
          <select class="form-control" id="assigned_to" name="assigned_to" multiple {% if not can_edit_assignee %}disabled{% endif %}>
            {% for user in users %}
              <option value="{{ user.id }}" {% if user in task.assigned_to.all %}selected{% endif %}>{{ user.username }}</option>
            {% endfor %}
          </select>
          {% if not can_edit_assignee %}
            <input type="hidden" name="assigned_to" value="{{ task.assigned_to.all|join:',' }}">
            <div class="form-text text-muted">You don't have permission to change task assignments</div>
          {% else %}
            <div class="form-text">Hold Ctrl/Cmd to select multiple users</div>
          {% endif %}
        </div>
        
        <div class="mb-3">
          <label for="comments" class="form-label">Comments:</label>
          <textarea class="form-control" id="comments" name="comments" rows="4">{{ task.comments }}</textarea>
        </div>
        
        <div class="mb-3">
          <label for="attachments" class="form-label">Attachments:</label>
          <input type="file" class="form-control" id="attachments" name="attachments">
          {% if task.attachments %}
            <div class="mt-2">
              <a href="{{ task.attachments.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                <i class="fas fa-file me-1"></i>View Current Attachment
              </a>
            </div>
          {% else %}
            <div class="form-text text-muted">No attachment currently uploaded</div>
          {% endif %}
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'task_detail' task.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Task Details
          </a>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
